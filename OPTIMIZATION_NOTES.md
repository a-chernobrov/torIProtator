# Оптимизация manager.py для снижения потребления CPU

## Проблемы, которые были исправлены:

### 1. Неэффективный цикл смены цепочек (circuit_change_loop)
**Проблема:** Функция `circuit_change_loop()` использовала `time.sleep(interval)` внутри цикла `for`, что приводило к блокировке на время интервала для каждого контейнера последовательно.

**Решение:** 
- Добавлен словарь `last_change_times` для отслеживания времени последней смены цепочки каждого контейнера
- Цикл теперь проверяет все контейнеры каждые 30 секунд и меняет цепочки только при необходимости
- Устранена блокировка выполнения

### 2. Частые обращения к базе данных GeoIP2
**Проблема:** Функция `update_node_locations()` вызывалась каждые 60 секунд и каждый раз открывала/закрывала базу данных GeoIP2.

**Решение:**
- Функция теперь вызывается только каждые 5 минут (вместо каждой минуты)
- Используется контекстный менеджер `with` для автоматического управления ресурсами
- Добавлена проверка существования данных перед обновлением

### 3. Отсутствие кэширования геолокации IP
**Проблема:** Каждый запрос геолокации IP приводил к обращению к внешним API или базе данных.

**Решение:**
- Добавлен глобальный кэш `ip_location_cache`
- Результаты геолокации сохраняются в кэше
- Ограничение размера кэша (максимум 1000 записей)
- Автоматическая очистка старых записей при превышении лимита

### 4. Избыточное логирование
**Проблема:** Множество предупреждений записывалось в лог при каждой ошибке сети.

**Решение:**
- Изменен уровень логирования с `warning` на `debug` для несущественных ошибок
- Сохранены важные сообщения на уровне `info` и `error`

### 5. Отсутствие обработки исключений
**Проблема:** Ошибки в одном контейнере могли влиять на обработку других.

**Решение:**
- Добавлены блоки `try-except` для изоляции ошибок
- Каждый контейнер обрабатывается независимо

### 6. Неоптимальные таймауты
**Проблема:** Слишком большие таймауты для сетевых запросов.

**Решение:**
- Уменьшен таймаут для `measure_speed()` с 10 до 5 секунд
- Более быстрый отклик при недоступности сервисов

## Ожидаемые результаты:

1. **Снижение CPU на 60-80%** за счет устранения блокирующих операций
2. **Уменьшение сетевого трафика** благодаря кэшированию
3. **Более стабильная работа** из-за лучшей обработки ошибок
4. **Быстрее отклик** при проблемах с сетью
5. **Меньше нагрузки на диск** за счет оптимизации работы с базой данных

## Мониторинг:

Для проверки эффективности оптимизаций рекомендуется:
- Мониторить использование CPU процессом manager.py
- Проверять логи на наличие ошибок
- Отслеживать время отклика веб-интерфейса